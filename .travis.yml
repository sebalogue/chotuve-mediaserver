language: node_js

node_js:
  - '12.16'

services:
  - docker

before_install:
  - openssl aes-256-cbc -K $encrypted_c4f4ed3a2bbe_key -iv $encrypted_c4f4ed3a2bbe_iv -in super_secret.json.enc -out super_secret.json -d
  - wget -qO- https://toolbelt.heroku.com/install.sh | sh
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  - echo "$HEROKU_PASSWORD" | docker login -u "$HEROKU_USERNAME" --password-stdin registry.heroku.com

install: npm install

script:
  - NODE_ENV=test docker-compose up --build -d
  - docker exec -it chotuve-media-server npm test
  - docker-compose down
  - docker build -t chotuve-media-server .

deploy:
  - provider: script
    skip_cleanup: true
    script:
      docker tag chotuve-media-server registry.heroku.com/$HEROKU_APP_STAGING_NAME/web;
      docker push sebalogue/chotuve-mediaserver-staging;
      docker push registry.heroku.com/$HEROKU_APP_STAGING_NAME/web;
      heroku container:release web --app $HEROKU_APP_STAGING_NAME
    on:
      branch: staging

  - provider: script
    script:
      docker tag chotuve-media-server registry.heroku.com/$HEROKU_APP_NAME/web;
      docker push sebalogue/chotuve-mediaserver;
      docker push registry.heroku.com/$HEROKU_APP_NAME/web;
      heroku container:release web --app $HEROKU_APP_NAME
    on:
      branch: master


env:
  global:
  - secure: V9dbWb/zPpBJSDHZMlpr2iIZGDuC0BVvlvsSSK4MdGja6H2udEB9IsY6Ohtg4FFJiSft6JJcjPTjHU6IQSZcECer7CcMZaOF79krP7s7clGWfkzDYXxW0AATUceTNNqn024blmHNhD5PCdY97DQQP9uXnjcbAgfQWFEPVujSkuFjdcyS+bddV6hCqkzKlhPnWGxzr3kcaKaGvLJtPyruQmYY2wjHCuG09p/VfHsEdO6/DL4d8tBVgyrMbwXlxiQWZpbZDgRgznG1jvm+noIHkO+iHBAO5xa3SeypckQlxD4bLp1w2Z5b6V2yJXWxz2FXBHdJeR0r5j+Ec048M4M5lMht4Ypbv60mi4bKeI38R2oL6hK5tE/53mmpwHGrCenia3kkAaiJ/h2dRfSU/6HLq2EiOaN8gPUapI6liC8FX7z/5cWN6p1Rim+WkFTOe/3CtJMri297M794pnSO1RQ7c9HHqvnkMclaJBdaJmK1d0UFliGt/WP27ZGMz48sp0mm9qJGL8lFUo3LNyT/UDS4u+EU9WCZ9C5UZw4eICx2v7/musmcJhh8YUzCNui9ZvwyPDg5O6/2IT/901i/tXWZJ1RN9AlkLR778OTXhENjp2c14ip+rNXHwaVSHKiU/Z2/V24dEAMPvmsE1iEDuWG31g9cJltcKlmGnnru91a5Npk=
  - secure: Nd2fdcnIGoL7JrFekaQ1c3IFve9gjEOHfgMt5OB/joy9X6/3YESVci/pMitcZ8dneNMWoevCiL6C8V7Il3EGyNwyP6+acB2JJU/tDKDAmWAMcL4uUW0MA6iEN3hxsmXloPgSXxp/cHyvT82ZlThGBA1sHnHPQOvBF7v+DnrfSD3UsmVouV5POyVfq3ANbpOq2irWACV8VmP74SjZLu5ixqnbm7du8eTS/uGXWkcpKjDU1igBGlQ/OFzIypY5ZW0dmnDL+8Ae7/rg+IGpHiKF1SlPr2N0i0tt7zzE5G1V7MnhiO74Gng9iIVZvBLOFhL9/p+bT4RnjwKK10cBpqTi/Hij8FMHrl2xg0jOiTEWF3/dw4/mRkyeqRgE/x+JsU/V/zncfOuGDVtZ36+MStlcl4KB3O5Ij7mIWbXF2hCS/YbLzUTD45yl7HbYZfogXLUJFqKv7ZWpsj3qBW/C6RmsE8tSC4aSf9aYRLG0rf4ZRTLxD6TWq1OudH25GuOivDVWvK7GODUcPOoowLl1Q47QiYBdrE6OXT2GJW/WVVxm8xRMePPXmHgQIzFP+ZfpX0E0P9QD4ltipeFY13a8IENtIt/FJIaO/LrUCfZiOvnLYO/VvVQWw/ey/kV+YT/qkADKUK7wnIfGLCsdr6waxTS5DyfkA1dxAVKoX5YOyocSDVY=
  - secure: r9Z88VnADF7i6puO5FlSfLUujMQAviqXimhwC3UscO8FK5fLHfNn1P1I/U//ZUUfYnWisfthOv9I7d3O93wAT9Lqcg0OPv6DnJc9V81azChyX/Tq9DuG2rdsM19WRAmbMMRzjjXP12euSBOxEjgTvPyk0b2B2ce7VxEptHfpSibJHjZGgyCgK7XhI9VS6ps6b50e5Ikkz4JnsPhOC6BerBTeAm1Tpug4/fYmEyU/IaFA4/+9oqnD/odAiMOxobMsff+UsdNd5WQbQFPpoejnGcmX6LU4aArRzLbW4a5yfkXhagQpLV9lRL5LPRLARJzY5C5Rp6DBtYOs0Pm5MfkACmDvUvDbM1DfvQaI/N00HF/2iYoURaHdgOJyBNiqw3YwXUYlc6aO3JSp+fAl68iP5YYVUO2jEpH2bIOr84mRU63Vd24LKHCPm69nGQRY4WTaleGKKPfjbjqPXZ7gDVovlF+1rx86elT7VPfTRTH1/dWPRO7oXgPvXkMEw7jD68Bs5C5wD9rXgJkyTfHd3I7NVfq+HgX6z8yNPF7sw7MuSbCrG50YPSspfr7JcS98TddSSob7I87l8AT8hMiWnzmRDzpN5cuKq3z47gwBxnY3YDprVrlF8veadgz65AjEXrnqa5us6ObILcq37dImP3AhXCj1WzSMNJCSkojD+4qE9zE=
  - secure: UQnPAXzsgR78otl/isgBJhetfGXRPm6jJBcNCCvZcoL/b7wIW+HQyUYJewky8n0toaOSmMZYHLz75eILGrDOZyxAMxenJAoMSb0NUY34PfINfbNv7S0Uw8OhF+go297DyCM+MvgjOem897Uz22VyowDXdhCTN977kARZ661cqfo4b7Cvnz0sO6DQT3YoMUVquwuet7kAlVTQVNg06rvP2pIZsUtD0CCOIQyahzSkaVV0HQOcMVaQUU7JIMiVIVxXbdSh0G3UOSZq/BHEQxW6gf0CNbrruNEW/AW4jY5pZ0I+4Olpe0kwQGmEPXXugWtWZAzS5AGOhuVSuqD1kFAY7V0SdDcpYeAoZpE8bowSSt6FujDW+xZKPVQhQLmEBFaTmRTqbhkCqG+uxqWj5C50z4uLnIDp09h6BjrRBNdGC60/w+nlfBlv0E4+eMMXbMXqoG1egpJVWbOuMzrwKln5w++WW7av55l860o+xBUf9EgI4D4bx8NpFeql2vp14mgct6nLDqdnbd1RQPEchSBehFt/jLps8PxW9F6ZzApCtoZKxS1yEavjkYkf11a1k3gLz5Bv/epE+ZQMbI+Nmg0Xmx8lewT1cMAnFuioHV6aEg5pBzG5k88HkoC4rWKEuE4/4RJJDx3LZHNRTGl6gCjom72elkjORFF9R/a6Pt1Kt7c=
  - secure: jsHbooQHSH/7ZJB02BapyoQLmPA6Wcg6HmIPc0An1LbZZsQclHpHCGnCLHoLZjfAOou6U+/eGolMW9Xj8RsQRA1SrHP3ra5P5g3zIVjFW0VShPBYNEC5Jl8bZhNjb21b+VN12bS73OmH4ySeCwV4Zls+0l2LzXC+8nFzLmOXywtjWuv56Mpwq1y/NdETID7ASH+MzColorkD7SHh5L/pue3kRLrqp2/FlmRB3FkZLlP4JN0u7JR3xUTZuxa7ec2ibtOfHxc1Wg8mGdH87ZzM147mhB/DEi+pxjNgxIGkuvsQzXiWJLKn0+VnBe9Me65txWP/+b4RhamU6I+k1br1ZluWEGBE+Km6MSRMB219wAzDUc4jrcs+nh+gtoDhAfTMfVoOAvGAiN4zBPVcYgN8yd4Q3015yV80wBbv5vK8fLudHr+vWK98S2Vfx+6ADtKTiTJ6WJuR2ZhUlKrceVSLpGlRpjIW31TSqPBrVgpQj2U/IXAX1xlxJf6B+2aXOblqn2sJyI/cAfUsk4CEuhpUYJqIm0tFVi23mfJN2nWeKY+9NGYuUVqLJnfddENI9pdrPNzrKB+VLwCsE+oGsgKrQgWUP5cuA+L5IJMrt+efGriMvAVDQX/47EGGe3I4SfiCFNZCzdry5KgIwTcPZdxYIL6zXK4eUaQptE0bkVRvkrU=
  - secure: cGw9tUkEsyX9cfEEQcEJzrntmrD8LXqitplIgMFDzZyL02AMAyhyRC607WseyEqGzztLbRrn82Jg6zB7jkNhy1zDznbJe/Dw7IqCa2hsKzxVVlBxlZbxMYanB4pBC8VANrAGI8hxml1ol/iknMlUexv0bb5V61vyGR6ltYKRxvRsjEpnSQhKGky0GhT2UywdEqQycdeS2kLK1ls9JYAuvS+amxiKwtCLGKu/XNlvERwtuqrzpRbFQHcoXJTgfakx3IEwOcbw1RXY1fSQUs7tkb/6opLp18MXqoJ517IsgnHCEhTi8Uv4XXjMDNFQifyMfCMo6tW0ZrZKBp1Uug9qF9Ecr7EbfxpyIcgl+if/T/wgkWh3bkavEBe0SemhDny0MqbpqVsRvfdKMeYzPGQWklghGZrSXkSlDZELiIWqJ0azzlFlAAdOp2EECX28BvVvbpzKsACjnjUCjYQKj2//kW7iuxEMoJ938cyO51mLj25UL8zEih1W0XWtv65pD7+QGikGQcpwiRuCHmkKu+/LXZ3Qc7G1Cp9+gte4DRAZCbKDpxFcBlCqV9GGnIKsCPIXadcSCA8YcvGTLMnWTxvL1ysNgkjgbFlocJo/2y0Zqsfn6LPgX7w7yjYxQv2QnUBOFIYynje34Nu3gYp2EAdpC1kdC4D0HZaDbCJU28LdjPA=
  - secure: FU2A6C5i98e15dwHlcb1qWhqWDsbELx3jqjnruGVXnRECnXVGbm1VSU7To3FwhI8R7UQ2wTHUcv4g5it2xOgPX0mPUNpJ1x2t4QtV251hl2WHr+7ek8HFVeeRrV0hhEx4unpu5w1cEciZIMLFYnclvwDY6fY+Gb+jOBL3KA/boZZoTeuSFiobbxOW7CojndCs4fMrTZgq9PYGrRYh1ZpvRBg1fD+funqeilEg263mmCi3TXkL+PVIDO4lsSeJJokfGISr0zPNbUPPlT14ZWC3uxHrW4giYWnJTEVUE/drgTktklqJi8FNrPG1Ko5hVZdzy0+JEGY+9pTyLph5sUNOGtWhcwTrJDXychBn7tMR1G+yMraIMwjH8svG6RmZAJJPhuWMwydNjU+XcoNzhVaJZl9CP1d8jJq79pl29zDk6TGsMdL7uLOhtqawfOHcDZyryo/mzOaKDpGVXKr4LqPXKVsW5ltnObGfxvRohg8oCw9ZCUIDbcEEyMWBr/sefFHEoi3EzCUeBRNyRYOqn3YWLOt1A11EdipMy1iXUxzzh/O6/JezgHJ3urccbcocgfA5ggYnE8H3LaYNbmybAIryVaBcFNEQQ2WneWCX7uduSTtAS92D2MiVgNEbeWNXX/4IPLdzxvQtlw9Z2WOjMJjAYCZjhzdy0JHYNrpVbi+egQ=
  - secure: b3z5lOcjPa94RRiOV/MK8F7obWJdOp6lua/MO6yWEgk+JPN4qne65Uh6XHWOCXjDcGeHrcRwpwPligJSfQUZ0XyDhHDtTYCaScJpagmqr8pOdIzOe4unDnR5NqJqVuQdYQ0kXy5lADlKVowMyk6N1OuiP6jo5NzkynexKE3Gt49aUco1aLq1JWV1hPRwV8/rWpowSlx0bXemKEUEd4oJQWbqaa0kLbeY1r8W7I3VmzsCeQpjCgf5hRSGbydYQwyISoXt3chlKB5dh8es7tOoXovqf89gHzdTKZIZ/WNG127CpEi7Y3jTYrfynP/Jb0BHWjNWLd+1czi2t1z1JmJMqguhJSi7XgOyNCvMCbX/9/a/sFyAg7BBSMt2aaNb5A5x/O++tIEwPG1PQcWJkby3uvVrylhzRsUmcweXJyY+muklpSiQzHedYtK5irQ7srr2W7+x3ARXeBxNKcZgAadMn1bnW6dT4DaT9zYoivpEv918uybsX5bVvXQDYusz3g8mGA4bqyFBXXwWQ+gFDfUFQz85dKx5BPdWWWRvNblveBYozGXHIxsDCdlfI1tdA5SETgvoTdUiHrEjlTbPvrRnyhoYVg1MFJ19zAu0DeW22HT266wrG6kVD3WjZHNQM04a5dVdCJo5cis++1okvuISXZc+b5xtUrVq9amjElAuX0M=
